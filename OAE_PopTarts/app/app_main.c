/*
 * app_main.c
 *
 *  Created on: Sep 19, 2023
 *      Author: veswaranandam
 */

#include <stdio.h>
#include <app_core.h>
#include <main.h>
// #include "TLV320ADC3120.h"
#include <arm_math.h>
#include "dual_dma.h"
#include "adc.h"
#include "lut.c"
#define NS 128
#define n_data 1000
#define M_PI 3.14159265358979323846
#include <stdbool.h>
#include <dsp/fast_math_functions.h>

#include <stm32l4xx_hal_sai.h>
#include <stm32l4xx_hal_dac.h>

extern DAC_HandleTypeDef hdac1;
extern DMA_HandleTypeDef hdma_dac_ch1;
extern TIM_HandleTypeDef htim6;
extern SAI_HandleTypeDef hsai_BlockA2;
extern I2C_HandleTypeDef hi2c3;

// // frequency calculation - set to 
// pts = 128; // number of points
// targetFS = 2; // KHz - target frequency in kHz
// TriggerFS = targetFS * pts; // KHz - intermediate calc
// Fclk = 80000000; // MHz - timer clock
// PSC = 0; // prescaler value for timer
// ARR = Fclk / (TriggerFS * (PSC+1.0)) - 1; // ARR value for timer
// ARR = 312.49 // ARR value for 2KHz
// 6 cycles max of a singular frequency

#define FFT_LEN (4096)

volatile uint32_t data_i2s[FFT_LEN];
volatile uint32_t data_i2s_2[FFT_LEN];



// arm_rfft_fast_instance_f32 S_;
// arm_rfft_fast_instance_f32 *S = &S_;

int fft_cycles = 10; // must be even to start with

float32_t fft_output[FFT_LEN]; // would be length of fft_cycles +1 for inital

void fft(float *current_buffer)
{
//	uint32_t *current_buffer = fft_cycles % 2 == 0 ? data_i2s : data_i2s_2;
//	uint32_t *next_buffer = fft_cycles % 2 == 0 ? data_i2s_2 : data_i2s;
//	for (int i = 0; i < FFT_LEN; i++)
//	{
//		current_buffer[i] = (float)current_buffer[i];
//	}
	// arm_rfft_fast_init_f32(S, FFT_LEN);
	// arm_rfft_fast_f32(S, current_buffer, fft_output, 0);
	// further analysis here & output
	// median of noise bins
	// if good
	// mean of noise
	// mean of dpoae
	// sum noise and dpoae into total
	// counter of good vs bad -> if test bad
	//  keep dpoae total and log it
	//  divide noise and dpoae by total
	//  subtract noise from dpoae
	//  log to find snr

//	if (fft_cycles > 0)
//	{
//		HAL_SAI_Receive_DMA(&hsai_BlockA2, (uint8_t *)next_buffer, sizeof(next_buffer));
//		fft_cycles--;
//	}
}

void HAL_SAI_RxCpltCallback(SAI_HandleTypeDef *hsai)
{
	// fft();
}
uint32_t Wave_LUT[] = {
	254935671,113508887,26411279,103612647,122814661,116458228,56361351,40108423,136577606,53149825,79102540,170197237,253100459,142541651,232719095,103481640,233570876,131073011,118686148,211747337,173998395,50790897,70386499,208601794,162399115,191758950,243990579,117965403,3539586,94437557,194707727,126288602,225312841,127075289,11404103,14155819,82051165,95814109,224133855,32244324,29688156,233571096,267780534,177930345,249430631,42861374,262079185,81985883,193331624,242221092,38404403,5242981,158401047,66060771,133956314,11731117,226164751,230425288,186843165,17695296,249037095,217317683,202900424,235340690,73728986,31523067,250938145,202572550,120127679,63964125,35782959,88670705,267387661,34144817,165610056,25624826,170983862,115736875,126288529,19661006,131531638,58262063,86180009,204800216,205783375,145621559,207421860,28705067,165478540,121504257,56295620,18088647,85066414,96338517,41418752,241632020,59441751,264176174,168755731,87753152,26149433,85721091,3015463,229835062,127664644,53739570,21561451,236453997,113050090,13631523,244973643,266666646,234225796,103546981,175637394,173342945,67764982,116588881,106955748,187302356,243728717,176554525,151584899,227410749,169935756,151978912,94437992,75366733,81133733,208863451,25821888,114295764,188285297,230162807,199229849,8913760,191562477,223478552,239010553,3211527,86049288,65077606,122356568,15729550,166199310,67108890,92472259,3933140,205783268,168427872,55051259,120914352,180158642,20185604,192611088,146932482,263323945,263783032,212206549,209912503,34472802,82837951,96010817,226492798,196215528,267583699,266535831,81461326,71172396,107085842,180880266,248382175,15991428,70648713,230687232,252117964,197919687,137888550,209912528,209191126,129172162,165151477,103613116,19464857,188023016,204341558,103613173,258080837,266928130,13107809,103284951,190186405,47972570,107151648,200278498,58917306,157746150,68354165,195035292,21037742,111411726,267125043,247792385,235733598,25231914,12452236,46990306,184418760,182779937,132579908,137822808,148701472,23986848,179176367,9502912,214237410,146670073,241238217,239403740,232521958,22610216,238355260,111542404,167838511,221315097,5178313,207487296,90243588,217056038,114622762,214434735,222888887,9503079,64618574,194904240,136774535,54133016,98173204,215482733,82904055,133563285,240124603,137232919,173671057,187499069,48103650,145621432,72352002,40174376,196805403,124387902,76415811,88277460,194511314,237437719,206373256,12386592,138477582,254411108,188285284,229638579,156369141,145162456,48693383,227541728,265486417,70320433,138871665,3670645,12714356,10027527,128582463,84148344,136250058,30409295,152240145,193855767,13042674,185533017,141886112,60228357,38469757,185598698,68748236,264372320,215679886,201720109,235799080,206176903,179241096,159253135,144507678,215875785,169345671,91685388,78381797,105251209,211943962,20709894,182845517,244187707,89915688,8913412,148505299,128713233,47513985,90636955,27853643,147980561,110560233,174916291,20513107,30277980,224329746,152633847,214958841,1573452,154075771,62783707,77267322,38863864,257032380,110429018,127009524,231539390,87949430,249103272,51839391,265027785,99484048,155845522,86180522,52953614,245236464,100204642,135922241,199098580,35651827,153289529,207225220,116654888,222430035,150405704,61538792,105512983,248972035,207749922,251593162,200868229,163971619,83624727,163250879,189857921,189792357,31392087,95420696,189989127,259064234,162071335,198902096,263389233,36897654,208339819,124452932,172360261,69730678,111083630,259653867,71172607,101909487,47841582,118817133,112722309,184615404,204013805,14746523,147194354,113312275,256180527,21299982,245826400,116130655,229376009,225116463,122028881,9634530,157221065,162136237,109707606,149618719,58458541,122945978,31917026,38273454,127926895,204866166,189465349,45351139,65929372,38208415,69337861,219611629,206635112,200147664,102826959,219414558,100991901,24379788,118620903,197132599,108069541,24052622,120521405,214500201,28181172,197919098,169476247,231998127,53608544,124846658,83362091,15860692,261489173,54002407,254280431,264569336,122225366,225706905,104465354,124125964,46334819,88211980,144835148,86311252,173539799,107348072,109117687,83100667,47449072,186450396,85786984,118358726,62129016,225313490,180028411,26739605,135659531,197656890,38207825,35717512,75039203,193135535,255394587,197853691,174456867,130810462,112984858,7668538,107741997,150601967,146538611,113574579,214303259,191496232,157745627,78512231,118816874,187498783,34603182,149291984,128713565,16450380,55443649,44040531,37552211,76088118,183567251,264307248,241042252,65273867,262384,115999268,187826905,98435241,209060021,26018336,34734894,56295649,155845062,94241775,131531259,1508301,47645137,68288665,235996135,155124097,81395977,137625694,86704460,106693031,141558313,74122182,152043608,97518235,118358334,166920844,105710240,261096086,155058782,75956558,84803821,205848995,194380190,151913348,9175134,118292771,68092786,8651174,211223041,151978755,179372403,117309881,58328029,49807771,259653750,10813721,42533221,267911335,134480438,63111894,151782224,119275542,106234196,241696919,100729089,212009783,143655837,54460490,177799427,94438241,10486386,200671273,225313003,33030292,260702482,227083168,250740825,146800988,73204197,146604613,127467862,128975250,117506336,38797684,101450298,166723645,174129292,21954654,58261930,241565726,165872099,102629538,242942080,92078285,90374741,56426751,233505473,62718879,191300013,102105133,50660138,95682754,19596110,69862179,66847165,42664261,215352256,213188967,29557528,30737126,100401983,182911330,202769216,133693789,192217322,258998668,194249454,97911155,32703188,119800348,68223874,165150962,95682646,130810592,2031863,53084237,222757302,215876277,6751206,49742066,55903230,10093420,200999280,186450934,223084598,53870622,154206797,215613838,224002358,83361965,21758725,200868292,79102203,124190817,64421899,207355938,167642049,99615486,112066721,214040941,172884174,75825681,51577738,230687207,212992908,42271550,78184898,189465006,57803229,65995271,110035104,197002008,240190081,223216475,40108285,110035732,1966087,83951770,113312102,81657914,139002869,52823014,151323375,229376346,178520473,113180709,67175320,11666320,214368670,171442424,237633840,230556353,174588307,1049429,91750732,83165355,214565227,11272295,57606168,162398892,73991126,87490891,132055780,76087504,238224337,141165234,116916685,103678534,105841261,244514921,17039780,7012818,207618608,173015263,40960004,245432651,126222935,40960493,244581125,240779812,131531077,54985639,590517,129302816,21693072,5833020,256246229,198574881,205521390,20972370,109314590,95420643,3932934,219939065,149226376,215875859,252314194,67698754,68027003,207159935,39977117,206242456,138937040,246743567,36700652,267322307,106103546,111214861,32048003,130613819,13500423,140706695,27525964,150143209,185925717,238814207,202572154,103809332,124321966,153682564,117441175,260834015,131662780,152502340,70517509,65012392,88146357,202900066,192872888,173736744,23855154,32375047,54526028,233636307,76349730,34472469,6750595,145490815,68354623,69927432,27657055,211681402,186647384,166855092,37815013,23331705,168558906,254738632,235275197,175570991,183436186,258670763,131989773,130679285,267190630,18613213,197394951,94109816,75170288,158990883,137167327,63832367,249299532,194314744,86180165,207618596,41419327,59769635
    };
void app_setup(){
	// print(ARR);
	// int i = 0;
	// for (float t = 0; t < (2*PI); t+= ((2*PI/(NS-1))) /*linspace points from 0 to 2pi*/) {
	// 		uint32_t f1 = (2048 * (arm_sin_f32(6* t)+1));
	// 		uint32_t f2 = (2048 * (arm_sin_f32(5* t)+1));
	// 		  //for dual right alignment (page 624 of reference manual)
	// 		  Wave_LUT[i] = (f1 << 16) | (f2 >> 2);
	// 		  i++;
	// }
	
	HAL_DAC_Start_DualDMA(&hdac1, DAC_CHANNEL_12D, (uint32_t*) Wave_LUT, 768, DAC_ALIGN_12B_R);
	HAL_TIM_Base_Start(&htim6);
	//init_adc_nointerupt();
	// TLV320ADC3120_Initialize(&dev, &hi2c3);
	// uint8_t status = HAL_GPIO_ReadPin(ADC_Interupt_GPIO_Port,ADC_Interupt_Pin);
	HAL_SAI_Receive_DMA(&hsai_BlockA2,(uint8_t*) data_i2s, sizeof(data_i2s));
	
	// status = HAL_GPIO_ReadPin(ADC_Interupt_GPIO_Port,ADC_Interupt_Pin);
}

uint32_t fft_start = 0;
uint32_t fft_end = 0;
uint32_t time = 0;
uint32_t blink_time = 0;
// bool CheckButtonState(GPIO_TypeDef* port,GPIO_TypeDef* pin, unsigned long time);
uint8_t counter = 0;
bool endflag = false;
void app_loop()
{
	float current_buffer[FFT_LEN];
	uint8_t f = 1;
	for (int i = 0; i < FFT_LEN; i++)
	{
		current_buffer[i] = (float)sin(f*((float)i/FFT_LEN)*2*PI);
	}

	fft_start = HAL_GetTick();
	fft(current_buffer);
	fft_end = HAL_GetTick();
	uint32_t fft_time_ms = fft_end - fft_start;

	//	w(0x12,0x02,0x00);
	// // DO not use HAL_Delay -> generates an interrupt that halts DMA channels
	// time = HAL_GetTick();
	// if ((time - blink_time) > 500) {
	//     HAL_GPIO_TogglePin(LD1_GPIO_Port,LD1_Pin);
	//     HAL_GPIO_TogglePin(LD2_GPIO_Port,LD2_Pin);
	//     blink_time = time;
	// 	counter++;
	// 	//w(0x12,0x02,SLEEP_CFG_AREG_SELECT_INTERNAL & SLEEP_CFG_SLEEP_ENZ_ACTIVE);
	// }
	// if (counter == 200 && endflag == false){
	// 	// end_adc();
	// 	endflag = true;
	// }
    // // if (CheckButtonState(SW1_GPIO_Port,SW1_Pin,time)){
    // // 	HAL_GPIO_TogglePin(LD3_GPIO_Port,LD3_Pin);
    // // }
	// HAL_Delay(1000);
	// HAL_GPIO_TogglePin(LD3_GPIO_Port,LD3_Pin);
}

// #define BUFFER_SIZE 128
// int16_t adcData[BUFFER_SIZE];
// int16_t dacData[BUFFER_SIZE];
// static volatile int16_t *inputBufferPtr;
// static volatile int16_t *outputBufferPtr = &dacData;

// uint8_t dataReadyFlag;

// void HAL_I2S_DR_Half_Callback(SAI_HandleTypeDef *hi2s){
// 	inputBufferPtr = &adcData[0];
// 	outputBufferPtr = &dacData[0];

// 	dataReadyFlag = 1;
// }

// void HAL_I2S_DR_Full_Callback(SAI_HandleTypeDef *hi2s){
// 	inputBufferPtr = &adcData[BUFFER_SIZE/2];
// 	outputBufferPtr = &dacData[BUFFER_SIZE/2];
// 	dataReadyFlag = 1;
// }

// #define INT16_TO_FLOAT 1.0f/32768.0f
// #define FLOAT_TO_INT16 32768.0f

// void processData(){
// 	static float leftIn, leftOut;
// 	static float rightIn, rightOut;
// 	for (uint8_t n = 0; n < (BUFFER_SIZE/2) - 1 ; n+= 2){
// 		leftIn = INT16_TO_FLOAT * inputBufferPtr[n];
// 		if (leftIn > 1.0f){
// 			leftIn -= 2.0f;
// 		}

// 		leftOut = leftIn;
// 		outputBufferPtr[n] = (int16_t) (FLOAT_TO_INT16 * leftOut);
// 		rightIn = INT16_TO_FLOAT * inputBufferPtr[n + 1];
// 		if (rightIn > 1.0f){
// 			rightIn -= 2.0f;
// 		}
// 		outputBufferPtr[n + 1] = (int16_t) (FLOAT_TO_INT16 * rightOut);
// 	}
// 	dataReadyFlag = 0;
// }
