# OAE Firmware

## Setup

Clone this repository in a directory of your choice.

Install [STM32CubeIDE](https://www.st.com/en/development-tools/stm32cubeide.html) from their website. 
It may ask you to make an account. You will still need this even if you are planning to use VS Code.

## Import

#### STM32CubeIDE

Open STM32CubeIDE. If it asks to create a workspace, accept the default and continue. Do not create a new project.

Go to the top right and click "File". In the dropdown, select "Open projects from filesystem".

Select the LED_NucleoFlash directory in the file picker and import the project.

You may have to repeat the above two steps occasionally.

#### VS Code

In addition to STM32CubeIDE also install [STM32CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html), [STM32CubeCLT](https://www.st.com/en/development-tools/stm32cubeclt.html) and [STMCUFinder](https://www.st.com/en/development-tools/st-mcu-finder-pc.html).

Open VS Code and install [this](https://marketplace.visualstudio.com/items?itemName=stmicroelectronics.stm32-vscode-extension) extension.

For easier debugging, install [Embedded Tools](https://marketplace.visualstudio.com/items?itemName=ms-vscode.vscode-embedded-tools), [CMake Tools](https://marketplace.visualstudio.com/items?itemName=ms-vscode.cmake-tools), and [C/C++ Tools](https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools)

Open the STM32 sidebar, then click import local project and select LED_NucleoFlash/.cproject.

After everything has finished downloading, restart VS Code and in the status bar, from right to left, select the debug preset, the debug preset again, LED_NucleoFlash, LED_NucleoFlash again, and Default.

## Edit

Open STM32CubeIDE and unfold LED_NucleoFlash.
Within it, you should see a .ioc file. Double click it and accept any dialogs. This will allow you to set up the peripherals and clocks. After editing and saving, it should ask whether to generate code. Click 'yes'.

All of our independent code is located in LED_NucleoFlash/app/app_main.c

The LED_NucleoFlash/Core/Src/main.c contains the actual main file that gets compiled. Avoid editing this unless you need to (for example, to add a new function hook from app_main.c), as this will be regenerated by STM32CubeIDE every time you edit the STM32's configuration.

### app_main.c

This file contains hooks to the sections `/* USER CODE BEGIN 2 */` and `/* USER CODE BEGIN 3 */` as `app_setup` and `app_loop` respectively.

#### Adding variables

To access a variable from main.c that is defined above `/* USER CODE BEGIN 2 */`, go to the private variables section in LED_NucleoFlash/Core/Src/main.c and note the type and name of the variable. Then, write a type statement in app_main.c with the keyword `extern`, the type, and the name of the variable. This helps the compiler find the variable in question by announcing that it was created outside app_main.c file.

#### Adding hooks

To add a function hook in app_main.c to another section in main.c, add a type statement with the function under `/* USER CODE BEGIN PFP */` in LED_NucleoFlash/Core/Src/main.c and call the function inside the user code block section of your choice.

## Run/debug

Note that during flashing or debugging, LD1 (large led array) will flash red and green on the Nucleo. If LD2 is off, there is likely a short. After a debug session, if the microcontroller is stopped, press the rear button to reset the Nucleo.

#### STM32CubeIDE
Set up the project as normal, then connect the Nucleo and build, then either Run or Debug from the toolbar. If any errors are present, they will be located in the console. You can also set breakpoints as usual in your code and debug from there.

#### VS Code
Unlike STM32CubeIDE, the only way to flash your code is through debugging. Building will create a .elf file that you can load with external tools.

To debug, select the run and debug sidebar, then click launch. Afterwards, select terminate (if you don't want to debug). When LD1 is no longer blinking, hit the reset button and your code should be running as normal.

For debugging, VS Code will normally start with the assembly file. However, you can place breakpoints in app_main.c and it will stop at the corresponding assembly as well, similar to STM32CubeIDE. You can also view registers and peripherals in the run and debug sidebar.
